%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Hierarchical Inference in Weak Lensing: Inferring Pr(e)
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[useAMS,usenatbib]{mn2e}
%% letterpaper
%% a4paper

% \voffset=-0.8in

% Packages:
% \input psfig.sty
\usepackage{xspace}
\usepackage{graphicx}

% Macros:
\input{macros.tex}
\input{addresses.tex}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\title[Hierarchical Inference in Weak Lensing]
{Hierarchical Inference of the Intrinsic Ellipticity
Distribution of Galaxies during Weak Lensing Analysis}
    
\author[Tang et al]{%
  Yike~Tang$^{1}$,
  David W. Hogg,$^{1}$
  Philip~J.~Marshall$^{2}$
  \medskip\\
  $^1$\nyu\\
  $^2$\oxford
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}
             
\date{to be submitted to MNRAS}
             
\pagerange{\pageref{firstpage}--\pageref{lastpage}}\pubyear{2010}

\maketitle           

\label{firstpage}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% in this abstract, below, check the use of -, --, and ---.  Understand?

\begin{abstract}
Weak-lensing projects---to measure galaxy--galaxy lensing or the shear--shear
correlation function---often make use of estimators that involve simple or weighted
means of measured galaxy ellipticities.  Here we propose moving to a probabilistic inference
framework for weak-lensing projects, in which the both the distribution of unlensed
(intrinsic) galaxy ellipticities and the distribution of ellipticity measurement noise contributions
are both treated as priors.  We perform hierarchical inference to \emph{infer} the
unlensed ellipticity distribution simultaneously with the shear map.  The best
shear-field estimators (point estimates), in this context, become
maximum-\emph{marginalized}-likelihood estimates, in which uncertainty about the
inferred unlensed distribution has been marginalized out.  We show that our proposed
estimators perform better than simple mean-ellipticity estimators both in terms of
bias and variance.  We also show that as the number of observed galaxies becomes
large, the performance of our proposed estimators approaches the performance of a
magical maximum-likelihood estimator that could be constructed if the true unlensed
ellipticity distribution were known \textit{a priori}.  Importantly, this work only
considers the \emph{catalog-level} problem of how to combine galaxy ellipticity
measurements; it does not consider the problem of making those measurements in the
first place.  In the end we argue that weak lensing projects ought to move beyond
point estimates and instead propagate full likelihood-function information about
the shear field forward into scientific analyses.  Only this could properly
propagate uncertainty without introducing additional catalog-generated variance.
\end{abstract}

% Full list of options at http://www.journals.uchicago.edu/ApJ/instruct.key.html

\begin{keywords}
  gravitational lensing
\end{keywords}

\setcounter{footnote}{1}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  SECTION 1: INTRODUCTION
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\section{Introduction}

\label{sec:intro}

\flag{Yike}{Plan the sections of your paper, and write very brief
notes on what you want to say in each of them. You will find it helpful
to divide them into sub-sections, and even paragraphs. You may also
want to put in placeholder figures and tables; if you do, make sure
to write the captions of them. The itemized conclusions should be
partial answers to a corresponding list of questions in the introduction.
You can write these now, as incomplete statements: when you know what
your findings are, you can complete them.}

% WL as cosmological and astrophysical probe. 


% Information is scarce. 
% Expensive, high precision future. Motivation.


% This paper: toy problem, exploring one aspect of analysis.


% History of shear estimation, and treatment of Pr(e).


Weak gravitational lensing has become the most potential tool to explore
the dark universe. One application of Weak gravitational lensing is
that it can be used to measure the mass profile of single galaxy,galaxy
groups and clusters or large scales. Cosmic shear is the mild distortion
of distant galaxy images due to the bending of light by intervening
matter.It provides one of the most promising methods for constraining
the nature of dark energy (Albrecht et al. 2006; Peacock\&Schneider
2006). While in galaxy--galaxy weaklensing ,tangential shear distortions
of background galaxies around foreground galaxies, allows direct measurement
of the galaxy-DM correlation

The distortion in Weak lensing is typically ~ 0.01,or ~0.001 for
galaxy-galaxy lensing. It's usually more than 10 times smaller than
the intrinsic shape noise,it's also smaller than the distortion caused
be PSF effect which is usually around ~0.05 level. For shear measurement
the main source of uncertainty comes from the intrinsic shape noise
.Since the unlensed galaxy shape can not be observed directly the information
we have about the intrinsic ellipticity is scarce,other than  the assumption that 
the orientational angle should be isotropic. With
this assumption,an estimator can be made by simply averaging galaxies' complex
ellipticity.However by doing this we will not be able to utilize the
information about how the ellipticity are distributed. Simple average
point estimator can't use the other reasonable assumption about intrinsic
shape distribution --galaxies in different sky patches should have
the same shape distibution--which is the natural result of the homogeneous Universe.

A typical procedure of weak lensing analysis  includes ellipticity
measurement,shear inference and mass profile reconstruction. The measurement
of galaxy shapes is the first step of weak gravitational lensing analysis,since
it's the direct observable that relates with tangential shear.However
in this paper we only concern about how to infer shear from galaxy
ellipticity in a hierachical way.Therefore in our simulation we merely
set up a simple toy model in which we have the observed ellipticity as
data,and the only measurement error we consider is a Gaussian noise
added on the lensed galaxy ellipticity.We also suppose there is a uniform shear
acting on one all the galaxies in sky patch,

Our approach is to use an exceedingly flexible model for intrinsic
shape distribution,and assumes all the galaxies in different patches
abeys such a distribution.Then we can calculate the joint likelihood
of shpape distribution parameters and shears in different sky patches.With
a classical Gibbs MCMC sampler we are able to sample their posteior
distriibution.After marginalizing the shape parameters, we can obtain
the posterior distribution of shear,which we are interested in.This
approach allows us use the information maximumly without introducing
in any wrong assumption on intrinsic shape distribution.

In galaxy--galaxy lensing ,since the distortion is so weak,what people
usually do is stack many lensing signals together and get the mean
shear map,and then infers the mean mass profile of galaxy or galaxy
cluster. However with HB method we can avoid this brute averaging
,instead we can get the posterior distribution of mass profile for
each lensing system - even though it may have very large uncertainty- we
can calculate their statistical property like galaxy-mass correlation
function via this posterior distribution.

This paper is orgnized as following: In section 2 we introduce the
weak lensing formulas and the likelihood function .Then we describe
two flexible models for the intrinsic shape distribution. In section
3 we show the result of the MCMC sampling ,and check the bias and
variance of sample mean and compare with that of the simple average
method.In Section 4 we discussed

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  SECTION N: XXX
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\section{method}

\label{sec:XXX}


\subsection{Likelihood Functions}

We assume the lensed galaxy ellipticity $\epsilon_{\ell}$ is related
to the intrinsic galaxy ellipticity $\epsilon_{0}$ in the weak lensing
regime via 
\begin{equation}
\epsilon_{\ell}=\frac{\epsilon_{0}+g}{1+g^{*}\epsilon_{0}}
\end{equation}


and it's inverse formula 
\begin{equation}
\epsilon_{0}=\frac{\epsilon_{\ell}-g}{1-g^{*}\epsilon_{\ell}}
\end{equation}
from Schramm \& Kayser (1995), Seitz \& Schneider (1997), where $\epsilon$
is represented as a complex variable and g, $g^{*}$ are the reduced
shear and its complex conjugate, respectively. In weak lensing region we have 
\begin{equation}
g=\frac{\gamma}{1-k}\approx\gamma
\end{equation}
$\gamma$ is the shear .This is the assumption we use through out
the paper.$\epsilon$ is defined in terms of the major and minor axes and orientation a, b, $\phi$,
respectively, as
\begin{equation}
\epsilon=\frac{a-b}{a+b}e^{2i\phi}
\end{equation}
Due to the isotropicity of Universe ,for the unlensed ellipticity $\epsilon_{0}$ 
we expect $\phi$ has a uniform distribution
from 0 to $\pi$.Then we can expect 
\begin{equation}
<\epsilon_{\ell}>=g
\end{equation}
Therefore $<\epsilon_{\ell}>$ can be adopted as an estimator of g.

However in our hierachical Bayesian approach we are able to obtain
the posterior distribution of g ,based on the assumption $\phi$ has
a uniform distribution and galaxies in different sky patches have
the same intrinsic shape distribution.

Suppose we know the ellipticity distribution of unlensed galaxies
based on some parasmeters $\alpha$,then we can write the likelihood
of reduced shear and $\alpha$:

\begin{equation}
p(\epsilon_{\ell}|\vec{g},\alpha)=p(\epsilon_{0}(\vec{g})|\alpha)*|\frac{\partial\epsilon_{0}}{\,}{\partial\epsilon_{\ell}}|
\end{equation}


Note that both $\epsilon_{0}$ and $\epsilon_{\ell}$are complex numbers.So
$|\frac{\partial\epsilon_{0}}{\partial\epsilon_{\ell}}|$ is the Jacobian
determinant term,which can be calculated numerically from formula
(5).

If there is measurement error on $\epsilon_{ob}$,we will have 
\begin{equation}
p(\epsilon_{ob}|\vec{g},\alpha)=\int f(\epsilon_{ob}|\epsilon_{\ell})\, p(\epsilon_{\ell}|\vec{g},\alpha)
\end{equation}
Here the prior distribtuion we use for $\vec{g}$ is a 2D flat distribution
in the region $|g|<1$.Therefore $p(\vec{g)}=\begin{cases}
1 & |\vec{g}|<1\\
0 & |\vec{g}|>1
\end{cases}$

The prior of $\alpha$ some how depends on the model we choose for
intrinsic ellipticity distribution .When we use the step function
model for P($\epsilon_{0}$),which we'll describe latter.We find that
we need to use a prior on $\alpha$ . 
\begin{equation}
p(\vec{\alpha}|\xi)=exp(-\xi\sum(\alpha_{i}-\alpha_{i-1})^{2})
\end{equation}


Given the likehood functions and priors we can also calculated the
marginalized likelihood function. 
\begin{equation}
p(\epsilon_{\ell}|\vec{g})=\int p(\epsilon_{\ell}|\vec{g},\alpha)p(\alpha|\vec{g})d\alpha
\end{equation}


Since $p(\alpha)$ does not explicitly depends on $\vec{g}$ .$p(\alpha|\vec{g})$is
just the pror distribution $p(\vec{\alpha}|\xi)$.Therefore,we have
marginalized likehood 
\begin{equation}
p(\epsilon_{\ell}|\vec{g})=\int p(\epsilon_{\ell}|\vec{g},\alpha)\, p(\vec{\alpha}|\xi)d\alpha
\end{equation}
Given that marginalized likelihood function ,in principle we could
optimize it and gives out a max-likelihood estimator for $\vec{g}$
in different patches simultaneously.

One thing to note is that the likelihood of g in patch i only depends
on the shape parameters but not dependent to g in other patch.Therefore,the
marginalized likelihood of shape parameters has an equation like:

\begin{equation}
\ell(\alpha|data)=\prod_{i}\ell_{i}(\alpha|data_{i})
\end{equation}


$\ell_{i}(\alpha|data_{i})$ is the marginalized likelihood function
calculated with data in the ith patch.From this formula we can see
how better estimation of $\alpha$ will be obtained if we infer more
sky patches simultaneously. With better knowledge on $\alpha$ we
can in turn have better estimates on reduced shear g.


\subsection{Model for Prior($\epsilon_{0}$)}

The correctness of posterior distribution of g depends on the intrinsic
ellipticity distribution P($\epsilon_{0}|\alpha$). Due to the limitation
of human's knowledge we are not able to give an analytical form of
$P(\epsilon_{0}|\alpha)$.Therefore we proposed an exceedingly flexible
model for $P(\epsilon_{0}|\alpha)$,which does not requires further
assumption on $P(\epsilon_{0}|\alpha)$.

We divide the 2-D space r$\in$(0,1) into N bins .The probability
of each bin is $p_{i}=e^{\alpha_{i}}$ .$\overrightarrow{\alpha}$
is a N-D parameter vector to be infered,simultaneously with g.

From practice we find that a prior smooth regularzation on $\alpha$
is needed to obtain a good estimation on shear g.

The prior distribution we used on $\alpha$ is : 
\begin{equation}
p(\vec{\alpha}|\xi)=exp(-\xi\sum(\alpha_{i}-\alpha_{i-1})^{2})
\end{equation}


Here $\xi$ is a prefactor need to be tuned .

Meanwhile,in order to show the correctness of our method ,we also
set up a simulation in which we know the true $P(|\epsilon_{0}||\alpha)$
is a Beta distribution ,and thus $\alpha$ is the 2-D parameter (p,q)
of the Beta distribution.We will show the posterior samples using
both of these two methods in next section. Note that for either model
we assume P($\epsilon_{0}$) is isotropic.


\subsection{Gibbs Sampler}

While making the posterior samples $p(g,\alpha|Data)$ we choose to
use the classical Gibbs sampler.

In Gibbs sampling ,samples of variable $x_{j}$ is made from the conditional
probability distribution:$p(x_{j}^{(i)}|x_{1}^{(i)},....,x_{j-1}^{(i)},x_{j+1}^{(i-1)}...,x_{n}^{(i-1)})$

While the conditional distribution of one variable given all others
is just proportional to the joint distribution

\begin{equation}
p(x_{j}|x_{1},....,x_{j-1},x_{j+1}...,x_{n})\varpropto p(x_{1},.....,x_{n})
\end{equation}


One thing to note is that the conditional probability of g in ith
patch only explicitly depends on $\alpha$ ,but not g in other patches.Therefore
with $\alpha$ fixed ,the posterior distribution of reduced shear
in ith patch are independent from each other . 
\begin{equation}
p(\vec{g}_{1}....\vec{g}_{n}|\alpha,Data)=p(\vec{g}_{1}|\alpha,Data_{1})....p(\vec{g}_{n}|\alpha,Data_{n})
\end{equation}
Therefore sampling reduced shear g from conditional distribution can
be reduced to 2D sampling problem,which can be done very quickly.

The total time needed to sample $g$ and $\alpha$ of 64 sky patches
with 8 galaxies in each patch will only be approximitly 25s on a 2
GHz CPU.


\subsection{Simulations}

The procedure of our simulation is that ,first we generated N{*}NP
unlensed galaxies' elliprticity from the ``true'' $P(\epsilon_{0})$,and
asign these galaxies into NP patches equally.So each patch has N galaxies.Second
we generate NP true reduced shears ,and asign them to each patch,and
then shear the unlensed galaxies using formula (4) .

Finally we can put on some noise on $\epsilon_{\ell}$ to get the
observed ellipticity $\epsilon_{ob}$. For simplicity we've only considered
the situation when P($\epsilon_{ob}|\epsilon_{\ell})$ is a 2D Gaussian.

Use Gibbs sampler and $P(\epsilon_{0}|\alpha)$ mentioned previously,we
are to sample the posterior distribution of g and $\alpha$ simultaneously
and effectively.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  SECTION N: XXX
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\section{Result}

\label{sec:XXX}


\subsection{Posterior samples}

We show the posterior samples of both g and $\alpha$ ,for both beta
function and step function model. 


\subsection{Bias Test}

We test the systematical bias of our estimator.(Here the estimator
is the max-marginalized likelihood estimator?) We plot $g_{1}-g_{1}^{true}$
VS $g_{1}^{true}$ ,and put on an error bar which equals standard
deviation of marginalized likehood functon $p(Data|g_{1})$ ,and use
a linear fit to determin the m,c value and their standard deviations.


\subsection{Accuracy Test}

We compare the mean square error of our estimator with average and
the estimator that could be constructed if the true unlensed ellipticity
distribution were known. We show how the mean square error varies
with number of galaxies ,number of patches and so on.


\subsection{Measurement Error}

We show some example how our method works when there is an Gaussian
noise added on the observed $\epsilon$


\subsection{prefactor $\xi$}

Discuss about how $\xi$ is tuned ,the danger if $\xi$ is set to
be too large or too small.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  SECTION N: XXX
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\section{Discussion}

\label{sec:XXX} In weak lensing survey,one way to obtain high S/N
ratio is to stack large number of lensing signal together,and calculate
the mean shear map of all these lensing systems.However simply to
stack all the lensing signals would not be the optimal way because
of the amount of information we can obtain from each lensing system
can be very different. The Bayesian inference approach we proposed
allows a natural way to optimally include all the data.In stead of
stacking what we need to do is to propogate the likelihood of the
shear map of each lensing system. The statistical property of all
the lensing systems like the galaxy-mass ,shear-shar correlation function
,in principle can be calculated from these likelihood functions.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  SECTION X: DISCUSSION
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\section{Discussion}

\label{sec:discuss}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  SECTION X: CONCLUSIONS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\section{Conclusions}

\label{sec:conclusions}

In summary,We have presented a conceptually hierachical inference
approach for weak lensing shear estimation, with carefully calculated 
uncertainty estimates.This method is intrinsically cope with high noise
levels on the input data and naturally allows bad fit to be identified 
from the residuals map. We also have proposed a flexible non-parametric model 
for intrinsic shape distribution allows us to obtain the correct posterior 
distributions, while avoiding making any unsupported assumptions.The Gibbs
sampler allows us to sample the posterior distribution of shear in large number of
sky patches simultaneously and efficiently.

Several  model fitting galaxy shape measurent method have been proposed in recent years.
Unlike the average method which merely request a point estimator of galaxy ellipcity,our hierachical bayesian
utilizes the whole likelihood of the galaxy ellipticity.
\begin{itemize}
\item We ...
\item The ...
\item The ...
\end{itemize}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  ACKNOWLEDGMENTS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\section*{Acknowledgments}

We thank XXX for useful discussions and suggestions.

\input{acknowledgments.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  APPENDICES
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 
% \appendix
% 
% \section{}
% \label{sec:appendix}
% 
% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  REFERENCES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


% MNRAS does not use bibtex, input .bbl file instead. 
% Generate this in the makefile using bubble script in scriptutils:


%   bubble -f PS1QLS-survey.tex references.bib 


 \bibliographystyle{apj}
\bibliography{references}
 %\input{PS1QLS-survey.bbl}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\label{lastpage} \bsp

\end{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\end{document}
